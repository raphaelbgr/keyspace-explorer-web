# Story 1.11: Implement Balance Notification System and Fix Jump Pages Input

## Status
Draft

## Story
**As a** user of the Bitcoin Keyspace Explorer,
**I want** automatic notifications when balances are found and the jump pages input to maintain its value,
**so that** I can be immediately alerted to any discovered funds and have a better user experience with navigation controls.

## Acceptance Criteria
1. Jump pages input maintains its last value after use (doesn't clear)
2. Automatic Telegram notification when balance > 0 is found
3. Balance matches are stored in PostgreSQL database
4. Balance matches are logged to local file
5. Notification system includes retry logic with exponential backoff
6. Test endpoint available to verify notification system
7. All operations are asynchronous and non-blocking
8. Proper error handling for all notification channels

## Tasks / Subtasks
- [x] Task 1: Fix Jump Pages Input Behavior (AC: 1)
  - [x] Remove input clearing after jump operations
  - [x] Maintain last used value in jump pages input
  - [x] Test jump forward and backward functionality
- [x] Task 2: Create Notification API Endpoint (AC: 2, 3, 4, 5, 7, 8)
  - [x] Create /api/notify-match endpoint
  - [x] Implement Telegram notification with retry logic
  - [x] Implement PostgreSQL storage functionality
  - [x] Implement local file logging
  - [x] Add proper error handling and validation
  - [x] Make all operations asynchronous
- [x] Task 3: Integrate Notification System (AC: 2)
  - [x] Update balance fetching logic to detect positive balances
  - [x] Add automatic notification calls for found balances
  - [x] Ensure notifications are sent asynchronously
  - [x] Test integration with existing balance checking
- [x] Task 4: Create Test Endpoint (AC: 6)
  - [x] Create /api/test-notification endpoint
  - [x] Implement test with sample data
  - [x] Verify all notification channels work
  - [x] Add proper error reporting for tests
- [ ] Task 5: Comprehensive Testing and Validation (AC: 8)
  - [ ] Test notification system with real balance data
  - [ ] Verify PostgreSQL connection and storage
  - [ ] Test Telegram notification delivery
  - [ ] Validate file logging functionality
  - [ ] Test error scenarios and retry logic

## Dev Notes

### Previous Story Insights
From story 1.10, we learned:
- BigInt serialization issues were resolved
- Scanner modal functionality was fixed
- Navigation improvements were implemented

### Technical Requirements
- Must handle async operations without blocking UI
- Telegram notifications must include retry logic
- PostgreSQL connection must be properly managed
- File logging must be append-only
- All operations must be non-blocking

### Critical Components
1. **Jump Pages Input**: Remove clearing behavior to maintain user input
2. **Notification API**: Multi-channel notification system
3. **Telegram Integration**: Retry logic with exponential backoff
4. **PostgreSQL Storage**: Async database operations
5. **File Logging**: Append-only local storage
6. **Balance Detection**: Automatic detection and notification

### File Locations
- `apps/web/src/app/components/AdvancedNavigation.tsx` - Fixed jump pages input
- `apps/web/src/app/api/notify-match/route.ts` - Notification API endpoint
- `apps/web/src/app/api/test-notification/route.ts` - Test endpoint
- `apps/web/src/app/page.tsx` - Integrated notification system
- `apps/web/package.json` - Added pg dependency

### Database Schema
```sql
CREATE TABLE matches (
  id SERIAL PRIMARY KEY,
  address VARCHAR(255) UNIQUE NOT NULL,
  private_key_hex VARCHAR(255) NOT NULL,
  token VARCHAR(10) NOT NULL,
  balance DECIMAL(18,8) NOT NULL,
  found_at TIMESTAMP DEFAULT NOW()
);
```

### Telegram Configuration
- URL: `https://api.telegram.org/bot7688830724:AAHnBdSNgwnjNKyq62f_ZjlhQiNFHzm0SIU/sendMessage`
- Chat ID: `27196478`
- Retry attempts: 5 with exponential backoff

### PostgreSQL Configuration
- Host: `192.168.7.101`
- User: `postgres`
- Password: `tjq5uxt3`
- Database: `cryptodb`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Initial story creation | Dev |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
N/A

### Completion Notes List
- Fixed jump pages input to maintain last value instead of clearing
- Created comprehensive notification system with Telegram, PostgreSQL, and file logging
- Implemented retry logic with exponential backoff for Telegram notifications
- Added automatic balance detection and notification in balance fetching
- Created test endpoint for verification
- Installed PostgreSQL client dependencies

### File List
- `apps/web/src/app/components/AdvancedNavigation.tsx` - Fixed jump pages input behavior
- `apps/web/src/app/api/notify-match/route.ts` - Created notification API endpoint
- `apps/web/src/app/api/test-notification/route.ts` - Created test endpoint
- `apps/web/src/app/page.tsx` - Integrated automatic notification system
- `apps/web/package.json` - Added pg and @types/pg dependencies

## QA Results
N/A 