# Story 1.9: Fix Bitcoin Address Generation to Match Expected Test Case

## Status
Draft

## Story
**As a** developer working on the Bitcoin Keyspace Explorer,
**I want** the Bitcoin address generation to produce the correct addresses for private key 1 and the scanner to automatically continue when no funds are found,
**so that** the application generates real, cryptographically correct Bitcoin addresses and continuously scans for funds until they are found.

## Acceptance Criteria
1. Private key 1 (0000000000000000000000000000000000000000000000000000000000000001) generates the correct addresses:
   - P2WPKH: bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4
   - P2SH: 3JvL6Ymt8MVWiCNHC7oWU6nLeHNJKLZGLN
   - Compressed: 1BgGZ9tcN4rm9KBzDn7KprQz87SZ26SAMH
   - Uncompressed: 1EHNa6Q4Jz2uvNExL497mE43ikXhwF6kZm
2. Bitcoin address generation uses proper cryptographic functions without fallback to mock addresses
3. All address types (P2PKH, P2WPKH, P2SH-P2WPKH, P2TR) are generated correctly
4. ECC library initialization is properly configured
5. Tests pass with the expected addresses for private key 1
6. Scanner automatically continues to next page when all wallet balances sum to 0
7. Scanner respects the selected scan mode (random, sequential, targeted) for continuation
8. Scanner stops only when funds are found or manual stop is triggered

## Tasks / Subtasks
- [ ] Task 1: Fix ECC Library Initialization (AC: 4)
  - [ ] Properly initialize bitcoinjs-lib with ECC library
  - [ ] Configure tiny-secp256k1 for Bitcoin address generation
  - [ ] Remove fallback to mock addresses
- [ ] Task 2: Implement Correct Bitcoin Address Generation (AC: 1, 2, 3)
  - [ ] Update KeyGenerationService to generate correct addresses for private key 1
  - [ ] Implement proper P2PKH address generation (compressed and uncompressed)
  - [ ] Implement proper P2WPKH address generation
  - [ ] Implement proper P2SH-P2WPKH address generation
  - [ ] Implement proper P2TR address generation
- [ ] Task 3: Create Validation Tests (AC: 5)
  - [ ] Create test for private key 1 with expected addresses
  - [ ] Test all address types match expected values
  - [ ] Ensure no fallback to mock addresses
  - [ ] Test with multiple private keys to ensure consistency
- [ ] Task 4: Implement Scanner Auto-Continuation (AC: 6, 7, 8)
  - [ ] Add logic to detect when all wallet balances sum to 0
  - [ ] Implement automatic page generation based on scan mode
  - [ ] Add sequential scanning mode (next page)
  - [ ] Add random scanning mode (random page)
  - [ ] Add targeted scanning mode (specific page range)
  - [ ] Implement scanner state management for continuous operation
  - [ ] Add stop conditions (funds found or manual stop)
  - [ ] Update ScannerModal to show continuous scanning status

## Dev Notes

### Previous Story Insights
From story 1.8, we learned:
- Bitcoin address generation was implemented but has ECC library issues
- Fallback to mock addresses is not desired
- Need to ensure real cryptographic address generation

### Expected Addresses for Private Key 1
- Private Key: 0000000000000000000000000000000000000000000000000000000000000001
- P2WPKH: bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4
- P2SH: 3JvL6Ymt8MVWiCNHC7oWU6nLeHNJKLZGLN
- Compressed: 1BgGZ9tcN4rm9KBzDn7KprQz87SZ26SAMH
- Uncompressed: 1EHNa6Q4Jz2uvNExL497mE43ikXhwF6kZm

### Technical Requirements
- Must use bitcoinjs-lib with proper ECC library initialization
- No fallback to mock addresses
- All address types must be cryptographically correct
- Tests must validate against known test cases
- Scanner must automatically continue when total balance is 0
- Scanner must respect selected scan mode for page selection
- Scanner must provide real-time status updates

### Scanner Behavior Requirements
- **Sequential Mode**: Generate next page number (current + 1)
- **Random Mode**: Generate random page number within specified range
- **Targeted Mode**: Generate specific page numbers in sequence
- **Auto-Continuation**: When total balance = 0, immediately generate next page
- **Stop Conditions**: When total balance > 0 OR manual stop triggered
- **Status Updates**: Show current page, scan mode, and balance status

### File Locations
- `apps/web/src/lib/services/KeyGenerationService.ts` - Fix Bitcoin address generation
- `apps/web/src/__tests__/services/KeyGenerationService.test.ts` - Add validation tests
- `apps/web/src/app/api/generate-page/route.ts` - Ensure proper error handling
- `apps/web/src/app/components/ScannerModal.tsx` - Update scanner interface
- `apps/web/src/app/page.tsx` - Implement scanner auto-continuation logic
- `apps/web/src/app/store/scannerStore.ts` - New scanner state management

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Initial story creation | SM |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
N/A

### Completion Notes List
N/A

### File List
N/A

## QA Results
N/A 