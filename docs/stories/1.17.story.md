# Story 1.17: Add Automatic Balance Checking on Page Load

## Status
Draft

## Story
**As a** user navigating to any page in the Bitcoin keyspace,
**I want** the system to automatically check balances for all generated wallet addresses when the page loads,
**so that** I can immediately see which addresses have funds without manually triggering balance checks.

## Acceptance Criteria
1. Automatically initiate balance checking when page generation completes
2. Display real-time loading indicators during balance checking process
3. Update balance information progressively as results come in
4. Handle balance checking errors gracefully without blocking page display
5. Provide user controls to skip/cancel automatic balance checking
6. Maintain page responsiveness during balance checking operations
7. Cache balance results to avoid redundant checks on page revisit
8. Integrate with real balance API system (requires Story 1.16)
9. Show clear visual distinction between checked and unchecked balances
10. Respect API rate limits during automatic checking

## Tasks / Subtasks
- [ ] Task 1: Implement automatic balance checking trigger (AC: 1)
  - [ ] Hook into page generation completion event
  - [ ] Trigger balance checking automatically after keys are generated
  - [ ] Extract all addresses from generated keys for checking
  - [ ] Initialize balance checking state management
- [ ] Task 2: Add progressive balance updates and UI feedback (AC: 2, 3, 9)
  - [ ] Implement real-time loading indicators per address
  - [ ] Update individual address balances as results arrive
  - [ ] Show progress tracking (X of Y addresses checked)
  - [ ] Add visual states: unchecked, checking, checked, error
- [ ] Task 3: Implement user controls and cancellation (AC: 5)
  - [ ] Add toggle to enable/disable automatic balance checking
  - [ ] Implement cancel/stop button during checking process
  - [ ] Add user preference persistence for auto-check setting
  - [ ] Provide manual "Check Balances" button as alternative
- [ ] Task 4: Ensure performance and responsiveness (AC: 4, 6, 10)
  - [ ] Implement non-blocking balance checking (async operations)
  - [ ] Handle API errors gracefully without crashing page
  - [ ] Respect rate limiting during automatic batch checking
  - [ ] Maintain UI responsiveness during large batch operations
- [ ] Task 5: Integrate caching and optimization (AC: 7, 8)
  - [ ] Check cache before making API calls for addresses
  - [ ] Store balance results in cache for future page visits
  - [ ] Integrate with real balance API system from Story 1.16
  - [ ] Optimize batch processing for 45+ addresses per page
- [ ] Task 6: User experience enhancements (AC: 5, 9)
  - [ ] Add settings panel for balance checking preferences
  - [ ] Implement balance checking status summary
  - [ ] Show time elapsed and checking rate during operations
  - [ ] Add tooltips explaining automatic balance checking
- [ ] Task 7: Testing and validation (AC: 1-10)
  - [ ] Test automatic triggering on page navigation
  - [ ] Verify progressive updates and cancellation functionality
  - [ ] Test error handling and recovery scenarios
  - [ ] Validate cache integration and performance

## Dev Notes

### Architecture Context
**Components to Modify:**
- `apps/web/src/app/page.tsx` (main dashboard integration)
- `apps/web/src/app/components/UltraOptimizedDashboard.tsx` (balance display)
- `apps/web/src/app/store/balanceStore.ts` (new or enhanced balance state management)
- Integration with balance API services from Story 1.16

**Current Issue:** Users must manually trigger balance checking; no automatic checking occurs when pages load.

### Previous Story Insights
Story 1.16 establishes real balance API integration. This story builds on that foundation to provide automatic balance checking workflow.

### Balance Checking Workflow
**Automatic Trigger Sequence:**
1. User navigates to new page or generates page
2. Key generation completes successfully
3. Extract all addresses from generated keys
4. Check cache for existing balance data
5. Queue uncached addresses for API checking
6. Begin progressive balance checking with rate limiting
7. Update UI as results come in
8. Cache new balance results

### State Management Enhancement
**Balance Store Interface:**
```typescript
interface BalanceState {
  isAutoCheckEnabled: boolean;
  isChecking: boolean;
  checkProgress: {
    total: number;
    checked: number;
    current: string | null;
  };
  balanceResults: Map<string, BalanceResult>;
  errors: BalanceError[];
  
  // Actions
  setAutoCheckEnabled: (enabled: boolean) => void;
  startBalanceCheck: (addresses: string[]) => Promise<void>;
  cancelBalanceCheck: () => void;
  updateBalanceResult: (address: string, result: BalanceResult) => void;
}
```

### UI/UX Implementation
**Loading States:**
- Individual address loading indicators
- Overall progress bar showing "Checking balances: X of Y"
- Address-level status indicators (unchecked, checking, checked, error)

**User Controls:**
- Settings toggle: "Automatically check balances on page load"
- Cancel button during active checking
- Manual "Check All Balances" button
- Individual "Check Balance" buttons per address

### Integration Points
**Page Generation Integration:**
- Hook into successful `generatePage` completion
- Extract addresses from `pageData.keys[].addresses`
- Trigger automatic balance checking based on user preferences

**Balance API Integration:**
- Must work with real APIs from Story 1.16
- Use batch processing and caching capabilities
- Respect rate limiting and error handling

### Performance Considerations
**Non-blocking Operations:**
- Use Web Workers or async operations for balance checking
- Maintain UI responsiveness during large batch operations
- Implement progressive rendering of balance results

**Rate Limiting:**
- Respect API rate limits during automatic checking
- Queue operations when rate limit is approached
- Provide user feedback about rate limiting delays

### User Experience Design
**Visual Feedback:**
```typescript
interface AddressBalanceState {
  address: string;
  status: 'unchecked' | 'checking' | 'checked' | 'error';
  balance?: number;
  error?: string;
  lastChecked?: Date;
}
```

**Settings Panel:**
- Toggle for automatic balance checking
- Rate limiting preferences
- Cache management options
- Balance checking history

### Error Handling
**Error Scenarios:**
1. API rate limit exceeded during auto-check
2. Network connectivity issues
3. Invalid addresses generated
4. API service unavailable
5. User cancellation during checking

**Error Recovery:**
- Graceful degradation when APIs fail
- Option to retry failed checks
- Clear error messaging to users
- Fallback to manual checking when auto-check fails

### Testing
**Test File Locations:**
- `apps/web/src/app/components/__tests__/AutoBalanceChecker.test.tsx`
- `apps/web/src/app/store/__tests__/balanceStore.test.ts`
- `apps/web/src/app/__tests__/pageLoadBalanceCheck.test.ts`

**Testing Framework:** Jest + React Testing Library + MSW for API mocking
**Test Cases Required:**
1. Automatic trigger on page load
2. Progressive balance updates and UI states
3. User cancellation and preference management
4. Error handling and recovery
5. Cache integration and performance
6. Rate limiting compliance

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-18 | 1.0 | Initial story creation for automatic balance checking on page load | Bob (SM) |

## Dev Agent Record

### Agent Model Used
[To be filled by dev agent]

### Debug Log References
[To be filled by dev agent]

### Completion Notes List
[To be filled by dev agent]

### File List
[To be filled by dev agent]

## QA Results
[To be filled by QA agent] 