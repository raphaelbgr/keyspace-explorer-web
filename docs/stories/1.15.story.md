# Story 1.15: Fix Key Index Display in Table View

## Status
**COMPLETED** âœ…

## Story
**As a** user examining Bitcoin keys in the table view,
**I want** the "Key#" column to show the absolute index of each wallet in the Bitcoin keyspace,
**so that** I can understand the exact position of each key in the global sequence rather than just the relative position on the current page.

## Acceptance Criteria
1. Key# column displays the absolute index in the Bitcoin keyspace (not page-relative position)
2. Key indices are calculated correctly using BigInt arithmetic for precision
3. First key on page 1 shows index 1, first key on page 2 shows index 46, etc.
4. Key indices account for the current keys-per-page setting (45, 100, 1000, etc.)
5. Table key numbers match the key numbers shown in expanded card views
6. Key indices remain accurate when users change keys-per-page settings
7. Index calculation handles edge cases near the keyspace boundaries
8. Index display uses readable decimal formatting (no scientific notation)

## Tasks / Subtasks
- [ ] Task 1: Analyze current key index calculation (AC: 1, 2)
  - [ ] Review `UltraOptimizedDashboard.tsx` table key number calculation
  - [ ] Review `KeyCard.tsx` and `LazyKeyCard.tsx` key number calculations
  - [ ] Identify discrepancies between table and card key number displays
  - [ ] Document current calculation formula and identify bugs
- [ ] Task 2: Implement correct absolute index calculation (AC: 1, 2, 3, 4)
  - [ ] Fix key index calculation to use absolute keyspace position
  - [ ] Use formula: `((currentPage - 1) * keysPerPage) + keyIndexOnPage + 1`
  - [ ] Implement BigInt arithmetic using Decimal.js for precision
  - [ ] Account for different keys-per-page settings dynamically
- [ ] Task 3: Ensure consistency across all views (AC: 5)
  - [ ] Update table view key index calculation
  - [ ] Update card view key index calculation  
  - [ ] Update expanded view key index display
  - [ ] Verify all components use the same calculation method
- [ ] Task 4: Handle keys-per-page changes (AC: 6)
  - [ ] Recalculate key indices when keys-per-page setting changes
  - [ ] Maintain correct indices during dynamic page size adjustments
  - [ ] Test index accuracy with different page sizes (45, 100, 1000, 10000)
- [ ] Task 5: Add boundary and formatting validation (AC: 7, 8)
  - [ ] Validate index calculations near keyspace start (page 1)
  - [ ] Validate index calculations near keyspace end
  - [ ] Apply decimal formatting to key indices (no scientific notation)
  - [ ] Add thousands separators for readability of large indices
- [ ] Task 6: Testing and validation (AC: 1-8)
  - [ ] Test key index accuracy across different pages
  - [ ] Test with various keys-per-page settings
  - [ ] Verify consistency between table and card views
  - [ ] Test boundary conditions and large index numbers

## Dev Notes

### Architecture Context
**Components Affected:**
- `apps/web/src/app/components/UltraOptimizedDashboard.tsx` (table view)
- `apps/web/src/app/components/KeyCard.tsx` (card view)
- `apps/web/src/app/components/LazyKeyCard.tsx` (lazy-loaded card view)
- `apps/web/src/app/components/KeyTableRow.tsx` (table row component)

**Current Issue:** Key# column shows relative position on page instead of absolute keyspace index.

### Previous Story Insights
Recent work established Decimal.js usage for BigInt precision and support for variable keys-per-page settings. The key index should reflect the absolute position in the Bitcoin keyspace sequence.

### Technical Requirements
**Current Problematic Calculation:**
```typescript
// This is likely showing page-relative position
const keyNumber = index + 1; // Wrong: only shows 1-45 on each page
```

**Required Absolute Index Calculation:**
```typescript
const calculateAbsoluteKeyIndex = (
  currentPage: string, 
  keysPerPage: number, 
  keyIndexOnPage: number
): string => {
  const currentPageDecimal = new Decimal(currentPage);
  const keysPerPageDecimal = new Decimal(keysPerPage);
  const keyIndexDecimal = new Decimal(keyIndexOnPage);
  
  // Formula: ((currentPage - 1) * keysPerPage) + keyIndexOnPage + 1
  const absoluteIndex = currentPageDecimal
    .minus(1)
    .times(keysPerPageDecimal)
    .plus(keyIndexDecimal)
    .plus(1);
    
  return absoluteIndex.toFixed(0);
};
```

### Component Integration Points
**UltraOptimizedDashboard.tsx:**
- Table view "Key#" column calculation
- Currently uses: `index + 1 + (currentKeysPage - 1) * keysPerPage`
- Should use absolute keyspace index

**KeyCard.tsx and LazyKeyCard.tsx:**
- Card header key number display
- Should match table view calculation exactly

**Data Models:**
- `currentPage`: string (BigInt-safe current page)
- `keysPerPage`: number (45, 100, 1000, 10000)
- `keyIndexOnPage`: number (0-based index within current page)
- `key.index`: number (from backend data, may need verification)

### Backend Data Validation
**Key Data Structure:**
```typescript
interface KeyData {
  privateKey: string;
  index: number; // This should be the absolute keyspace index
  pageNumber: string;
  addresses: AddressSet;
  balances: BalanceSet;
  totalBalance: number;
}
```

**Verification Needed:** Confirm that `key.index` from backend represents absolute keyspace position or if frontend calculation is required.

### Testing
**Test File Locations:**
- `apps/web/src/app/components/__tests__/UltraOptimizedDashboard.test.tsx`
- `apps/web/src/app/components/__tests__/KeyCard.test.tsx`
- `apps/web/src/app/utils/__tests__/keyIndexCalculation.test.tsx`

**Testing Framework:** Jest + React Testing Library
**Test Cases Required:**
1. Absolute index calculation accuracy
2. Index consistency between table and card views
3. Keys-per-page setting changes
4. Boundary conditions (page 1, large page numbers)
5. Decimal formatting of large indices

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-18 | 1.0 | Initial story creation for key index display correction | Bob (SM) |

## Dev Agent Record

### Agent Model Used
[To be filled by dev agent]

### Debug Log References
[To be filled by dev agent]

### Completion Notes List
[To be filled by dev agent]

### File List
[To be filled by dev agent]

## QA Results
[To be filled by QA agent] 