# Story 1.20: Multi-Currency Balance Database Integration

## Status
Ready for Development

## Story
**As a** system checking balances across multiple cryptocurrencies,
**I want** to query the appropriate database tables for each currency,
**so that** balance information is retrieved from the correct cryptocurrency-specific tables.

## Acceptance Criteria
1. Extend BalanceService to query wallets_bch, wallets_dash, wallets_doge, wallets_eth, wallets_ltc, wallets_xrp, wallets_zec
2. Implement parallel database queries for multiple currencies
3. Maintain existing Bitcoin balance checking functionality unchanged
4. Add address normalization before database queries (ETH, BCH prefixes)
5. Implement proper error handling for individual currency query failures
6. Ensure total query time does not exceed 150% of current Bitcoin-only queries
7. Add comprehensive logging for multi-currency balance operations
8. Create database connection pooling optimization for multiple table queries

## Integration Verification
- IV1: Existing Bitcoin balance queries must maintain current performance
- IV2: Database connection limits must not be exceeded during multi-currency queries
- IV3: All existing balance caching mechanisms must continue to function

## Tasks / Subtasks

### Task 1: Database Schema Integration
- [ ] Verify all currency-specific wallet tables exist and are properly indexed
- [ ] Create database views for unified multi-currency balance queries
- [ ] Add foreign key relationships where appropriate
- [ ] Implement database migration scripts for any missing constraints
- [ ] Test database performance with concurrent multi-currency queries

### Task 2: Multi-Currency Balance Service Enhancement
- [ ] Extend existing BalanceService to support all 8 currencies
- [ ] Implement currency-specific query methods for each wallet table
- [ ] Add parallel query execution for multiple currencies simultaneously
- [ ] Create unified balance result aggregation logic
- [ ] Implement currency-specific address normalization before queries

### Task 3: Database Query Optimization
- [ ] Implement connection pooling for multi-currency queries
- [ ] Add query result caching for frequently accessed addresses
- [ ] Optimize JOIN operations across multiple currency tables
- [ ] Implement batch query processing for large address sets
- [ ] Add database query performance monitoring and alerting

### Task 4: Address Normalization Layer
- [ ] Create address normalization utilities for database operations
- [ ] Implement ETH prefix removal (0x) before database queries
- [ ] Implement BCH prefix removal (bitcoincash:) before database queries
- [ ] Add address validation for each currency format
- [ ] Create reverse normalization for display purposes

### Task 5: Error Handling and Resilience
- [ ] Implement individual currency query error handling
- [ ] Add fallback mechanisms for database connection failures
- [ ] Create partial result handling (some currencies succeed, others fail)
- [ ] Implement query timeout handling for slow database operations
- [ ] Add comprehensive error logging and monitoring

### Task 6: Balance Aggregation Logic
- [ ] Create multi-currency balance aggregation functions
- [ ] Implement currency-specific balance formatting
- [ ] Add total portfolio value calculation across currencies
- [ ] Create balance comparison and sorting utilities
- [ ] Implement balance change tracking across currencies

### Task 7: Performance Monitoring and Optimization
- [ ] Add database query performance metrics collection
- [ ] Implement slow query logging and alerting
- [ ] Create database usage analytics for multi-currency operations
- [ ] Add memory usage monitoring for large result sets
- [ ] Implement query optimization based on usage patterns

## Dev Notes

### Database Architecture
```sql
-- Currency-specific wallet tables
wallets_btc (address, private_key, balance, created_at)
wallets_bch (address, private_key, balance, created_at)
wallets_dash (address, private_key, balance, created_at)
wallets_doge (address, private_key, balance, created_at)
wallets_eth (address, private_key, balance, created_at)
wallets_ltc (address, private_key, balance, created_at)
wallets_xrp (address, private_key, balance, created_at)
wallets_zec (address, private_key, balance, created_at)

-- Enhanced balance cache
balance_cache (address, currency, balance, source, cached_at, expires_at)
```

### Multi-Currency Service Interface
```typescript
interface MultiCurrencyBalanceService {
  async getBalancesForAllCurrencies(
    addresses: string[]
  ): Promise<MultiCurrencyBalanceResult>;
  
  async getBalancesForCurrency(
    currency: CryptoCurrency,
    addresses: string[]
  ): Promise<BalanceResult[]>;
  
  async aggregateBalances(
    results: MultiCurrencyBalanceResult
  ): Promise<AggregatedBalance>;
}
```

### Address Normalization Rules
- **ETH**: Remove "0x" prefix → Store: "a1b2c3...", Query: WHERE address = 'a1b2c3...'
- **BCH**: Remove "bitcoincash:" → Store: "qr2k...", Query: WHERE address = 'qr2k...'
- **Others**: Direct storage and query without modification

### Performance Targets
- Multi-currency query time: Maximum 150% of Bitcoin-only queries
- Database connections: Efficient pooling to prevent connection limit issues
- Memory usage: Optimize for large result sets across 8 currencies
- Cache effectiveness: Maintain existing cache hit rates across currencies

### Connection Pooling Strategy
- Separate connection pools for read/write operations
- Dynamic scaling based on multi-currency query load
- Connection timeout handling for long-running queries
- Load balancing across database replicas if available

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-22 | 1.0 | Initial story creation for multi-currency database integration | Bob (SM) | 