# Story 1.16: Implement Real Balance API Integration

## Status
Draft

## Story
**As a** user exploring Bitcoin addresses in the keyspace,
**I want** the system to fetch real balance data from blockchain APIs instead of fake/simulated data,
**so that** I can see actual Bitcoin balances and discover genuine funds in Bitcoin addresses.

## Acceptance Criteria
1. Replace fake balance data with real API calls to blockchain services
2. Integrate with multiple balance APIs (Blockstream, BlockCypher, etc.) for redundancy
3. Implement proper rate limiting and error handling for API calls
4. Cache balance results to minimize redundant API requests
5. Handle API failures gracefully with fallback to alternative APIs
6. Display real-time balance checking progress and status
7. Support batch balance checking for multiple addresses efficiently
8. Maintain balance checking performance under rate limits
9. Log all balance API calls for debugging and monitoring
10. Provide configuration options for different blockchain APIs

## Tasks / Subtasks
- [ ] Task 1: Remove fake balance data and analyze current implementation (AC: 1)
  - [ ] Identify all locations generating fake/simulated balance data
  - [ ] Remove mock balance generation from `KeyGenerationService.ts`
  - [ ] Review current `/api/balances` endpoint implementation
  - [ ] Document existing balance checking workflow
- [ ] Task 2: Implement Blockstream API integration (AC: 1, 2, 3)
  - [ ] Create `BlockstreamBalanceService.ts` for API integration
  - [ ] Implement address balance fetching from Blockstream API
  - [ ] Add rate limiting using exponential backoff strategy
  - [ ] Handle API response parsing and error cases
- [ ] Task 3: Implement additional API providers for redundancy (AC: 2, 5)
  - [ ] Create `BlockCypherBalanceService.ts` for alternative API
  - [ ] Implement `BalanceAPIManager.ts` to orchestrate multiple providers
  - [ ] Add provider failover logic when APIs are unavailable
  - [ ] Configure API priority and fallback order
- [ ] Task 4: Implement balance caching system (AC: 4, 8)
  - [ ] Create balance cache using Redis or in-memory storage
  - [ ] Implement cache key strategy (address-based)
  - [ ] Add cache expiration policies (TTL configuration)
  - [ ] Optimize cache lookups to reduce API calls
- [ ] Task 5: Add batch processing and performance optimization (AC: 7, 8)
  - [ ] Implement batch API requests where supported by providers
  - [ ] Add concurrent request processing with rate limit respect
  - [ ] Optimize for 45-address page balance checking
  - [ ] Implement request queuing for burst handling
- [ ] Task 6: Enhance UI feedback and monitoring (AC: 6, 9)
  - [ ] Add real-time balance checking progress indicators
  - [ ] Display current API status and provider being used
  - [ ] Implement balance checking logs and analytics
  - [ ] Add error reporting for failed balance checks
- [ ] Task 7: Configuration and testing (AC: 10, 1-9)
  - [ ] Add environment configuration for API keys and endpoints
  - [ ] Create API configuration management system
  - [ ] Test with real blockchain data and API limits
  - [ ] Validate balance accuracy against known addresses

## Dev Notes

### Architecture Context
**Components to Modify:**
- `apps/web/src/lib/services/KeyGenerationService.ts` (remove fake balances)
- `apps/web/src/app/api/balances/route.ts` (enhance with real API calls)
- New balance service infrastructure

**Current Issue:** System generates fake balance data instead of querying real blockchain APIs for actual Bitcoin balances.

### Previous Story Insights
Existing balance checking infrastructure exists but uses simulated data. Recent work established notification systems that should trigger when real funds are found.

### API Integration Requirements
**Blockstream API Integration:**
```typescript
interface BlockstreamBalanceService {
  async getAddressBalance(address: string): Promise<BalanceResult>;
  async getBatchBalances(addresses: string[]): Promise<BalanceResult[]>;
  handleRateLimit(): void;
}

interface BalanceResult {
  address: string;
  confirmed: number;
  unconfirmed: number;
  total: number;
  error?: string;
}
```

**API Endpoints to Use:**
- Blockstream: `https://blockstream.info/api/address/{address}`
- BlockCypher: `https://api.blockcypher.com/v1/btc/main/addrs/{address}/balance`

### Service Architecture
**Balance API Manager:**
```typescript
class BalanceAPIManager {
  private providers: BalanceProvider[];
  private cache: BalanceCache;
  private rateLimiter: RateLimiter;
  
  async getBalances(addresses: string[]): Promise<BalanceResult[]> {
    // Check cache first
    // Use primary provider with fallback
    // Apply rate limiting
    // Update cache
  }
}
```

### Rate Limiting Strategy
**Implementation Requirements:**
- Respect Blockstream rate limits (vary by endpoint)
- Implement exponential backoff for 429 responses
- Queue requests during high-volume scanning
- Use concurrent requests within limits

### Caching Strategy
**Cache Implementation:**
- Key: Bitcoin address string
- Value: BalanceResult with timestamp
- TTL: 5-10 minutes for active scanning, longer for zero balances
- Storage: Redis for production, in-memory for development

### Integration Points
**Frontend Updates Needed:**
- Real-time balance update indicators
- API status display (which provider, rate limit status)
- Error handling for failed balance checks
- Progress tracking for batch operations

**Backend Service Integration:**
- Replace fake balance generation in `KeyGenerationService`
- Update `/api/balances` endpoint to use real APIs
- Add balance result caching and persistence

### Environment Configuration
**Required Environment Variables:**
```
BLOCKSTREAM_API_BASE_URL=https://blockstream.info/api
BLOCKCYPHER_API_TOKEN=your_token_here
BALANCE_CACHE_TTL=300
BALANCE_API_RATE_LIMIT=10
BALANCE_API_TIMEOUT=5000
```

### Error Handling
**Error Scenarios to Handle:**
1. API rate limit exceeded (429)
2. API service unavailable (500, 503)
3. Network timeouts
4. Invalid address format
5. API authentication failures

### Testing
**Test File Locations:**
- `apps/web/src/lib/services/__tests__/BalanceAPIManager.test.ts`
- `apps/web/src/lib/services/__tests__/BlockstreamBalanceService.test.ts`
- `apps/web/src/app/api/__tests__/balances.test.ts`

**Testing Framework:** Jest + Supertest for API testing
**Test Cases Required:**
1. Real API integration with known addresses
2. Rate limiting behavior and backoff
3. Cache functionality and TTL expiration
4. Provider failover scenarios
5. Batch processing performance

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-18 | 1.0 | Initial story creation for real balance API integration | Bob (SM) |

## Dev Agent Record

### Agent Model Used
[To be filled by dev agent]

### Debug Log References
[To be filled by dev agent]

### Completion Notes List
[To be filled by dev agent]

### File List
[To be filled by dev agent]

## QA Results
[To be filled by QA agent] 