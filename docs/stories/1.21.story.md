# Story 1.21: Multi-Currency Balance API Integration

## Status
Ready for Development

## Story
**As a** user checking balances for generated addresses,
**I want** the `/api/balances` endpoint to return balance information for all supported cryptocurrencies,
**so that** I can see funding status across all generated addresses.

## Acceptance Criteria
1. Extend `/api/balances` endpoint to accept multi-currency address arrays
2. Return balance information grouped by currency with appropriate formatting
3. Maintain existing Bitcoin balance API response format for backward compatibility
4. Implement address normalization middleware for incoming requests
5. Add proper error handling for currency-specific balance lookup failures
6. Ensure API response time scales linearly with currency count (max 7x current time)
7. Add comprehensive error responses for invalid address formats
8. Update API documentation and examples for multi-currency usage

## Integration Verification
- IV1: Existing balance checking workflows must continue to function
- IV2: API error handling patterns must be consistent across all currencies
- IV3: Rate limiting and security measures must apply to all currency queries

## Tasks / Subtasks

### Task 1: API Endpoint Enhancement
- [ ] Modify `/api/balances` to accept currency-specific address arrays
- [ ] Implement request validation for multi-currency address formats
- [ ] Add currency parameter support for selective balance checking
- [ ] Maintain backward compatibility with existing Bitcoin-only requests
- [ ] Add proper TypeScript interfaces for multi-currency balance requests

### Task 2: Request Processing Layer
- [ ] Create address normalization middleware for incoming requests
- [ ] Implement currency detection and validation for submitted addresses
- [ ] Add request batching logic for efficient multi-currency processing
- [ ] Create request sanitization and validation rules
- [ ] Implement request size limits and pagination for large address sets

### Task 3: Balance Aggregation Logic
- [ ] Integrate with MultiCurrencyBalanceService for database queries
- [ ] Implement parallel balance checking across all currencies
- [ ] Create balance result aggregation and formatting
- [ ] Add currency-specific balance precision and display formatting
- [ ] Implement total portfolio calculation across all currencies

### Task 4: Response Format Design
- [ ] Design multi-currency response schema with backward compatibility
- [ ] Add currency-specific metadata (symbols, icons, precision)
- [ ] Implement grouped balance responses by currency
- [ ] Add balance summary and aggregation information
- [ ] Create currency-specific error reporting within responses

### Task 5: Error Handling and Resilience
- [ ] Implement individual currency error handling without affecting others
- [ ] Add partial success responses (some currencies succeed, others fail)
- [ ] Create comprehensive error codes for each currency-specific failure
- [ ] Implement graceful degradation for external API failures
- [ ] Add retry logic for transient database connection issues

### Task 6: Performance Optimization
- [ ] Implement response caching for frequently queried address combinations
- [ ] Add response compression for large multi-currency payloads
- [ ] Optimize database query patterns for multi-currency requests
- [ ] Implement request throttling and rate limiting per currency
- [ ] Add performance monitoring and alerting for API response times

### Task 7: API Documentation and Testing
- [ ] Update API documentation with multi-currency examples
- [ ] Create comprehensive test suites for all currency combinations
- [ ] Add integration tests for multi-currency balance workflows
- [ ] Document error response formats and troubleshooting guides
- [ ] Create developer examples for common multi-currency use cases

## Dev Notes

### API Request Structure
```typescript
interface MultiCurrencyBalanceRequest {
  addresses: {
    BTC?: string[];
    BCH?: string[];
    DASH?: string[];
    DOGE?: string[];
    ETH?: string[];
    LTC?: string[];
    XRP?: string[];
    ZEC?: string[];
  };
  currencies?: CryptoCurrency[]; // Optional filter
  includeMetadata?: boolean;
  cacheResults?: boolean;
}
```

### API Response Structure
```typescript
interface MultiCurrencyBalanceResponse {
  success: boolean;
  balances: {
    [currency in CryptoCurrency]: {
      [address: string]: {
        balance: string;
        confirmed: string;
        unconfirmed: string;
        source: BalanceSource;
        lastUpdated: string;
      };
    };
  };
  metadata: {
    totalAddresses: number;
    currenciesChecked: CryptoCurrency[];
    responseTime: number;
    cacheHitRate: number;
  };
  errors?: {
    [currency in CryptoCurrency]?: {
      message: string;
      code: string;
      affectedAddresses: string[];
    };
  };
  summary: {
    totalValue: {
      [currency in CryptoCurrency]: string;
    };
    fundedAddresses: number;
    totalAddresses: number;
  };
}
```

### Address Normalization Middleware
```typescript
const normalizeAddresses = (req: Request, res: Response, next: NextFunction) => {
  // ETH: Remove 0x prefix
  if (req.body.addresses.ETH) {
    req.body.addresses.ETH = req.body.addresses.ETH.map(addr => 
      addr.startsWith('0x') ? addr.slice(2) : addr
    );
  }
  
  // BCH: Remove bitcoincash: prefix
  if (req.body.addresses.BCH) {
    req.body.addresses.BCH = req.body.addresses.BCH.map(addr =>
      addr.startsWith('bitcoincash:') ? addr.slice(12) : addr
    );
  }
  
  next();
};
```

### Performance Targets
- Multi-currency response time: Maximum 7x Bitcoin-only time
- Response size optimization: Compression for payloads >1MB
- Cache effectiveness: Maintain >80% cache hit rate for repeated queries
- Error rate: <1% for well-formed multi-currency requests

### Rate Limiting Strategy
- Per-currency rate limits based on external API constraints
- Adaptive rate limiting based on response time patterns
- Priority queuing for cached vs. fresh balance requests
- Circuit breaker pattern for failing external APIs

### Currency-Specific Considerations
- **BTC**: Use existing Blockstream API integration patterns
- **ETH**: Handle Wei to ETH conversion and gas considerations
- **BCH**: Support both legacy and CashAddr formats
- **Others**: Implement placeholder external API patterns with graceful fallbacks

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-22 | 1.0 | Initial story creation for multi-currency balance API integration | Bob (SM) | 